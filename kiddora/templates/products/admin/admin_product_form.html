{% extends "base_admin.html" %}
{% block content %}

<style>
/* ================= LAYOUT ================= */
.form-box{
    width:54%;
    margin:40px auto;
    padding:28px;
    background:#f8f9fa;
    border-radius:16px;
    box-shadow:0 6px 14px rgba(0,0,0,.08)
}
h2{text-align:center;margin-bottom:24px}
label{display:block;margin-top:16px;font-weight:600}
input,textarea{
    width:100%;
    padding:9px;
    margin-top:6px;
    border-radius:8px;
    border:1px solid #cfcfcf
}
textarea{resize:vertical}
small{color:#666}

/* ================= DROPDOWN CHECKBOX ================= */
.dropdown{position:relative}
.dropdown-btn{
    width:100%;
    background:#fff;
    border:1px solid #cfcfcf;
    padding:9px;
    border-radius:8px;
    text-align:left;
    cursor:pointer
}
.dropdown-content{
    display:none;
    position:absolute;
    z-index:20;
    width:100%;
    background:#fff;
    border:1px solid #cfcfcf;
    border-radius:8px;
    padding:10px;
    max-height:200px;
    overflow-y:auto
}
.dropdown.open .dropdown-content{display:block}
.option{
    display:flex;
    gap:8px;
    align-items:center;
    margin-bottom:6px
}

/* ================= IMAGE ================= */
.image-preview-wrapper{
    display:flex;
    gap:12px;
    margin-top:12px;
    flex-wrap:wrap
}
.image-preview{
    width:120px;
    height:120px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid #ddd
}
.image-preview img{
    width:100%;
    height:100%;
    object-fit:cover
}

/* ================= CROP MODAL ================= */
.crop-modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    z-index:1000;
    align-items:center;
    justify-content:center
}
.crop-box{
    background:#fff;
    padding:16px;
    border-radius:14px;
    width:420px
}
.crop-box img{max-width:100%}
.crop-actions{
    display:flex;
    justify-content:space-between;
    margin-top:12px
}

/* ================= BUTTONS ================= */
.btn-primary,.btn-secondary{
    padding:9px 18px;
    border-radius:8px;
    border:none;
    color:#fff;
    cursor:pointer;
    text-decoration:none
}
.btn-primary{background:#f062c0}
.btn-secondary{background:#777}
.btn-primary:hover{background:#e04faf}
.btn-secondary:hover{background:#666}

.form-actions{
    display:flex;
    justify-content:space-between;
    margin-top:28px
}

.readonly{background:#eee}
</style>

<div class="form-box">
<h2>{% if product %}Edit Product{% else %}Add Product{% endif %}</h2>

<form method="post" enctype="multipart/form-data">
{% csrf_token %}

<!-- PRODUCT NAME -->
<label>Product Name</label>
<input type="text" name="product_name" value="{{ product.product_name|default:'' }}" required>

<!-- PRODUCT IMAGES -->
<label>Product Images <small>(Minimum 3 images, each must be cropped)</small></label>
<input type="file" id="product_images" accept="image/*" multiple>
<div class="image-preview-wrapper" id="previewWrapper"></div>

<!-- BRAND -->
<label>Brand</label>
<input type="text" name="brand" value="{{ product.brand|default:'' }}" required>

<!-- PRICING -->
<label>Base Price</label>
<input type="number" step="0.01" name="base_price" id="base_price"
        value="{{ product.base_price|default:'' }}" required>

<label>Discount %</label>
<input type="number" step="0.01" name="discount_percent" id="discount_percent"
        value="{{ product.discount_percent|default:0 }}">

<label>Final Price</label>
<input type="number" id="final_price" class="readonly" readonly>

<!-- CATEGORY (UI ONLY) -->
<label>Category</label>
<div class="dropdown" id="catDrop">
<button type="button" class="dropdown-btn" onclick="toggle('catDrop')">
Select Category
</button>
<div class="dropdown-content">
{% for cat in categories %}
<label class="option">
<input type="radio" name="cat_ui" data-cat="{{ cat.id }}">
{{ cat.category_name }}
</label>
{% endfor %}
</div>
</div>

<!-- SUBCATEGORY (ACTUAL POST FIELD) -->
<label>Subcategory</label>
<select name="subcategory" id="subcategorySelect" required>
<option value="">Select Subcategory</option>
{% for sub in subcategories %}
<option value="{{ sub.id }}"
        data-cat="{{ sub.category.id }}"
        {% if product and product.subcategory.id == sub.id %}selected{% endif %}>
{{ sub.subcategory_name }}
</option>
{% endfor %}
</select>

<!-- FABRIC -->
<label>Fabric</label>
<div class="dropdown" id="fabricDrop">
<button type="button" class="dropdown-btn" id="fabricBtn"
onclick="toggle('fabricDrop')">
{% if product %}{{ product.get_fabric_display }}{% else %}Select Fabric{% endif %}
</button>
<div class="dropdown-content">
{% for code,name in FABRIC_CHOICES %}
<label class="option">
<input type="radio" name="fabric" value="{{ code }}"
{% if product and product.fabric == code %}checked{% endif %} required>
{{ name }}
</label>
{% endfor %}
</div>
</div>

<!-- GENDER -->
<label>Gender</label>
<div class="dropdown" id="genderDrop">
<button type="button" class="dropdown-btn" id="genderBtn"
onclick="toggle('genderDrop')">
{% if product %}{{ product.get_gender_display }}{% else %}Select Gender{% endif %}
</button>
<div class="dropdown-content">
{% for code,name in GENDER_CHOICES %}
<label class="option">
<input type="radio" name="gender" value="{{ code }}"
{% if product and product.gender == code %}checked{% endif %} required>
{{ name }}
</label>
{% endfor %}
</div>
</div>

<!-- AGE GROUP -->
<label>Age Groups</label>
<div class="dropdown" id="ageDrop">
<button type="button" class="dropdown-btn" id="ageBtn"
onclick="toggle('ageDrop')">
Select Age Groups
</button>
<div class="dropdown-content">
{% for age in age_groups %}
<label class="option">
<input type="checkbox" name="ages" value="{{ age.id }}"
{% if age.id in selected_ages %}checked{% endif %}>
{{ age.age }}
</label>
{% endfor %}
</div>
</div>

<!-- COLORS -->
<label>Colors</label>
<div class="dropdown" id="colorDrop">
<button type="button" class="dropdown-btn" id="colorBtn"
onclick="toggle('colorDrop')">
Select Colors
</button>
<div class="dropdown-content">
{% for color in colors %}
<label class="option">
<input type="checkbox" name="colors" value="{{ color.id }}"
{% if color.id in selected_colors %}checked{% endif %}>
{{ color.name }}
</label>
{% endfor %}
</div>
</div>

<!-- ABOUT PRODUCT -->
<label>About Product</label>
<textarea name="about_product" rows="4">{{ product.about_product|default:'' }}</textarea>

<!-- ACTIONS -->
<div class="form-actions">
<a href="{% url 'products:admin_product_list' %}" class="btn-secondary">Back</a>
<button type="submit" class="btn-primary">Save Product</button>
</div>

<!-- CROP MODAL -->
<div class="crop-modal" id="cropModal">
<div class="crop-box">
<img id="cropImage">
<div class="crop-actions">
<button type="button" class="btn-primary" id="cropSave">Crop</button>
<button type="button" class="btn-secondary" id="cropCancel">Cancel</button>
</div>
</div>
</div>

</form>
</div>

<link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.css">
<script src="https://unpkg.com/cropperjs/dist/cropper.js"></script>

<script>
/* ========= DROPDOWN ========= */
function toggle(id){
    document.getElementById(id).classList.toggle('open');
}

/* ========= FINAL PRICE ========= */
const bp=document.getElementById('base_price');
const dp=document.getElementById('discount_percent');
const fp=document.getElementById('final_price');

function calc(){
    const b=parseFloat(bp.value)||0;
    const d=parseFloat(dp.value)||0;
    fp.value=(b-(b*d/100)).toFixed(2);
}
bp.oninput=calc;
dp.oninput=calc;
calc();

/* ========= CATEGORY â†’ SUBCATEGORY ========= */
document.querySelectorAll('input[name="cat_ui"]').forEach(r=>{
    r.onchange=()=>{
        document.getElementById('catDrop').classList.remove('open');
        const cid=r.dataset.cat;
        document.querySelectorAll('#subcategorySelect option').forEach(o=>{
            o.hidden=o.dataset.cat!==cid;
        });
        document.getElementById('subcategorySelect').value='';
    }
});

/* ========= IMAGE CROP ========= */
let files=[],cropper=null,activeIndex=null;
const input=document.getElementById('product_images');
const modal=document.getElementById('cropModal');
const img=document.getElementById('cropImage');
const preview=document.getElementById('previewWrapper');

input.onchange=()=>{
    [...input.files].forEach(f=>{
        files.push(f);
        openCrop(f,files.length-1);
    });
};

function openCrop(file,i){
    activeIndex=i;
    const r=new FileReader();
    r.onload=e=>{
        img.src=e.target.result;
        modal.style.display='flex';
        cropper?.destroy();
        cropper=new Cropper(img,{aspectRatio:1,viewMode:1});
    };
    r.readAsDataURL(file);
}

document.getElementById('cropSave').onclick=()=>{
    const canvas=cropper.getCroppedCanvas({width:800,height:800});
    canvas.toBlob(blob=>{
        files[activeIndex]=new File([blob],`img_${Date.now()}.jpg`,{type:'image/jpeg'});
        render();
        cropper.destroy();
        modal.style.display='none';
    });
};

document.getElementById('cropCancel').onclick=()=>{
    cropper.destroy();
    modal.style.display='none';
};

function render(){
    preview.innerHTML='';
    files.forEach(f=>{
        const r=new FileReader();
        r.onload=e=>{
            preview.innerHTML+=`<div class="image-preview">
            <img src="${e.target.result}"></div>`;
        };
        r.readAsDataURL(f);
    });
}

/* ========= FORM SUBMIT ========= */
document.querySelector('form').onsubmit=e=>{
    if(files.length<3){
        alert('Minimum 3 cropped images required');
        e.preventDefault();
        return;
    }
    const dt=new DataTransfer();
    files.forEach(f=>dt.items.add(f));
    input.files=dt.files;
};
</script>

{% endblock %}

