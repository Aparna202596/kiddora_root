{% extends "base_admin.html" %}

{% block title %}Admin Dashboard | Kiddora{% endblock %}

{% block content %}
<style>
.dashboard-wrapper {
    padding: 24px;
    background: linear-gradient(135deg,#f4f7fb,#eef2f7);
    min-height: 100vh;
}
.dashboard-title { font-size: 24px; font-weight: 600; margin-bottom: 24px; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 20px; }
.stat-card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
.stat-label { font-size: 13px; color: #777; }
.stat-value { font-size: 26px; font-weight: 700; margin-top: 6px; }
.stat-extra { font-size: 12px; margin-top: 6px; }

.bg-blue { background: linear-gradient(135deg,#dbeafe,#eff6ff); }
.bg-green { background: linear-gradient(135deg,#dcfce7,#f0fdf4); }
.bg-yellow { background: linear-gradient(135deg,#fef3c7,#fffbeb); }
.bg-red { background: linear-gradient(135deg,#fee2e2,#fff1f2); }

.section { margin-top: 40px; }
.section-title { font-size: 18px; margin-bottom: 16px; font-weight: 600; }
.chart-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap: 24px; }
.chart-card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }

.table-wrapper { overflow-x: auto; background: #fff; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 12px 14px; font-size: 13px; border-bottom: 1px solid #eee; text-align: left; }
th { background: #f8fafc; font-weight: 600; }

.badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; color: #fff; }
.badge-green { background:#16a34a; }
.badge-yellow { background:#f59e0b; }
.badge-red { background:#dc2626; }

@media(max-width:768px){ .dashboard-title { font-size: 20px; } }
</style>

<div class="dashboard-wrapper">

    <h2 class="dashboard-title">Admin Dashboard</h2>

    <!-- ===== KPI CARDS ===== -->
    <div class="stats-grid">
        <div class="stat-card bg-blue">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value">{{ total_orders }}</div>
        </div>
        <div class="stat-card bg-green">
            <div class="stat-label">Completed Orders</div>
            <div class="stat-value">{{ completed_orders }}</div>
        </div>
        <div class="stat-card bg-yellow">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value">₹ {{ total_revenue }}</div>
        </div>
        <div class="stat-card bg-red">
            <div class="stat-label">Low Stock Products</div>
            <div class="stat-value">{{ low_stock_count }}</div>
        </div>
        <div class="stat-card bg-green">
            <div class="stat-label">Products Sold</div>
            <div class="stat-value">{{ products_sold }}</div>
        </div>
        <div class="stat-card bg-blue">
            <div class="stat-label">New Customers (30 Days)</div>
            <div class="stat-value">{{ new_customers }}</div>
            <div class="stat-extra">Growth: {{ customer_growth }}%</div>
        </div>
    </div>

    <!-- ===== CHARTS ===== -->
    <div class="section">
        <h3 class="section-title">Top Performance Analytics</h3>
        <div class="chart-grid">
            <div class="chart-card">
                <h4>Top Products Sold</h4>
                <canvas id="productChart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Top Categories</h4>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Top Brands</h4>
                <canvas id="brandChart"></canvas>
            </div>
        </div>
    </div>

    <div class="section">
        <h3 class="section-title">Advanced Analytics</h3>
        <div class="chart-grid">
            <div class="chart-card">
                <h4>Total Orders / Customers / Revenue</h4>
                <canvas id="donutChart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Products Sold (Last 7 Days)</h4>
                <canvas id="areaChart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Total Revenue (Monthly)</h4>
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ===== RECENT ORDERS ===== -->
    <div class="section">
        <h3 class="section-title">Recent Orders</h3>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>User</th>
                        <th>Status</th>
                        <th>Final Amount</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                {% for order in orders %}
                    <tr>
                        <td>{{ order.order_id }}</td>
                        <td>{{ order.user.email }}</td>
                        <td>
                            {% if order.order_status == "DELIVERED" %}
                                <span class="badge badge-green">Delivered</span>
                            {% elif order.order_status == "CANCELLED" %}
                                <span class="badge badge-red">Cancelled</span>
                            {% else %}
                                <span class="badge badge-yellow">{{ order.order_status }}</span>
                            {% endif %}
                        </td>
                        <td>₹ {{ order.final_amount }}</td>
                        <td>{{ order.created_at|date:"d M Y" }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">No orders available</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== TOP PRODUCTS ===== */
new Chart(document.getElementById('productChart'), {
    type: 'bar',
    data: {
        labels: [{% for p in top_products %}'{{ p.variant__product__product_name }}',{% endfor %}],
        datasets: [{
            label: 'Quantity Sold',
            data: [{% for p in top_products %}{{ p.total }},{% endfor %}],
            backgroundColor: 'rgba(79,70,229,0.7)',
            borderRadius: 6
        }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } } }
});

/* ===== TOP CATEGORIES ===== */
new Chart(document.getElementById('categoryChart'), {
    type: 'bar',
    data: {
        labels: [{% for c in top_categories %}'{{ c.variant__product__subcategory__category__category_name }}',{% endfor %}],
        datasets: [{
            label: 'Quantity Sold',
            data: [{% for c in top_categories %}{{ c.total }},{% endfor %}],
            backgroundColor: 'rgba(16,185,129,0.7)',
            borderRadius: 6
        }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } } }
});

/* ===== TOP BRANDS ===== */
new Chart(document.getElementById('brandChart'), {
    type: 'bar',
    data: {
        labels: [{% for b in top_brands %}'{{ b.variant__product__brand }}',{% endfor %}],
        datasets: [{
            label: 'Quantity Sold',
            data: [{% for b in top_brands %}{{ b.total }},{% endfor %}],
            backgroundColor: 'rgba(234,179,8,0.7)',
            borderRadius: 6
        }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } } }
});

/* ===== DONUT CHART ===== */

Chart.register({
    id: 'centerText',
    beforeDraw(chart) {
        const { ctx, chartArea } = chart;
        if (!chartArea) return;

        const centerX = (chartArea.left + chartArea.right) / 2;
        const centerY = (chartArea.top + chartArea.bottom) / 2;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        ctx.font = '12px sans-serif';
        ctx.fillStyle = '#374151';
        ctx.fillText('Customer Growth', centerX, centerY - 6);

        ctx.font = '11px sans-serif';
        ctx.fillStyle = '#6b7280';
        ctx.fillText('{{ customer_growth }}%', centerX, centerY + 8);

        ctx.restore();
    }
});

new Chart(document.getElementById('donutChart'), {
    type: 'doughnut',
    data: {
        labels: ['Total Orders','Customer Growth (%)','Total Revenue'],
        datasets: [{
            data: [{{ total_orders }}, {{ customer_growth }}, {{ total_revenue|floatformat:0 }}],
            backgroundColor: ['#aaa7e7','#9ce4cc','#fcaa7f'],
            hoverOffset: 6
        }]
    },
    options:{
        responsive:true,
        cutout: '50%', 
        plugins:{
            legend:{ display:true }
        }
    }
});

/* ===== AREA CHART (Products Sold Last 7 Days) ===== */
new Chart(document.getElementById('areaChart'), {
    type: 'line',
    data: {
        labels: [{% for day in last_7_days_labels %}'{{ day }}',{% endfor %}],
        datasets: [{
            label: 'Products Sold',
            data: [{% for qty in products_sold_per_day %}{{ qty }},{% endfor %}],
            fill:true,
            backgroundColor:'rgba(59,130,246,0.2)',
            borderColor:'rgba(59,130,246,1)',
            tension:0.3
        }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } } }
});

/* ===== LINE CHART (Revenue Trend) ===== */
new Chart(document.getElementById('lineChart'), {
    type:'line',
    data:{
        labels:[ 'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec' ],
        datasets:[{
            label:'Total Revenue',
            data:[ {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }},
                    {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }},
                    {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }},
                    {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }},
                    {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }}, {{ total_revenue|floatformat:0 }} ],
            borderColor:'rgba(220,38,38,1)',
            backgroundColor:'rgba(220,38,38,0.1)',
            fill:true,
            tension:0.3
        }]
    },
    options:{ responsive:true }
});
</script>
{% endblock %}
